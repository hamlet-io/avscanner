version: '3.5'

networks:
  internal:
    name: passport-scanner-data

services:
  localstack:
    image: psd-localstack
    container_name: psd-localstack
    build:
      context: ./localstack
      dockerfile: ./Dockerfile
    environment:
      - DEBUG=1
    ports:
      - '10000-10001:10000-10001'
    restart: on-failure
    networks:
      - internal

  minio:
    image: psd-minio
    container_name: psd-minio
    build:
      context: ./minio
      dockerfile: ./Dockerfile
    ports:
      - '9000:9000'
    restart: on-failure
    volumes:
      - '${dockerstagedir:-.}/minio/data:/minio-data'
    networks:
      - internal

  elasticmq:
    image: psd-elasticmq
    container_name: psd-elasticmq
    build:
      context: ./elasticmq
      dockerfile: ./Dockerfile
    ports:
      - '9324:9324'
    restart: on-failure
    networks:
      - internal

  processor:
    image: psd-processor
    container_name: psd-processor
    build:
      context: .
      target: base_dev
      dockerfile: ./devops/docker/Dockerfile
    depends_on:
      - minio
      - elasticmq
      - localstack
    env_file:
      - .env
    volumes:
      - '${dockerstagedir:-.}/src:/src'
    networks:
      - internal
